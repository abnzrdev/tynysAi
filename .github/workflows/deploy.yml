name: TynysAI CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── 1. Lint + Type Check ──────────────────────
  quality-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - run: npm ci
      - run: npm run lint
      - run: npm run type-check

  # ── 2. Build ──────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [quality-check]
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password123
          POSTGRES_DB: tynysdb
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U admin -d tynysdb"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - run: npm ci

      - name: Push DB schema
        run: npx drizzle-kit push
        env:
          DATABASE_URL: postgresql://admin:password123@localhost:5433/tynysdb
          DB_URL: postgresql://admin:password123@localhost:5433/tynysdb

      - name: Build Next.js
        run: npm run build
        env:
          DATABASE_URL: postgresql://admin:password123@localhost:5433/tynysdb
          DB_URL: postgresql://admin:password123@localhost:5433/tynysdb
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}

  # ── 3. E2E Tests (Playwright) ─────────────────
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [quality-check]
    timeout-minutes: 15
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: password123
          POSTGRES_DB: tynysdb
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U admin -d tynysdb"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - run: npm ci

      - name: Install Playwright + Chromium
        run: npx playwright install --with-deps chromium

      - name: Push DB schema
        run: npx drizzle-kit push
        env:
          DATABASE_URL: postgresql://admin:password123@localhost:5433/tynysdb
          DB_URL: postgresql://admin:password123@localhost:5433/tynysdb

      - name: Seed test data
        run: npm run seed
        env:
          DATABASE_URL: postgresql://admin:password123@localhost:5433/tynysdb
          DB_URL: postgresql://admin:password123@localhost:5433/tynysdb

      - name: Build Next.js
        run: npm run build
        env:
          DATABASE_URL: postgresql://admin:password123@localhost:5433/tynysdb
          DB_URL: postgresql://admin:password123@localhost:5433/tynysdb
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}

      - name: Run Playwright E2E tests
        run: npx playwright test
        env:
          DATABASE_URL: postgresql://admin:password123@localhost:5433/tynysdb
          DB_URL: postgresql://admin:password123@localhost:5433/tynysdb
          NEXTAUTH_URL: http://localhost:3000
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          IOT_DEVICE_SECRET: ${{ secrets.IOT_DEVICE_SECRET }}
          E2E_USER_EMAIL: ${{ secrets.E2E_USER_EMAIL }}
          E2E_USER_PASSWORD: ${{ secrets.E2E_USER_PASSWORD }}

      - name: Upload Playwright HTML report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload traces on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 7

  # ── 4. Docker build test (PRs only) ──────────
  docker-build-test:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Test Docker build (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: tynys-ai:test

  # ── 5. Deploy to Production ───────────────────
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            set -e
            cd /home/administrator/tynysAi

            echo "==> Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            if [ -f .env ] && grep -qE '^DB_URL=.*@tynys-postgres([:/]|$)' .env; then
              echo "==> Updating DB_URL host from tynys-postgres to host.docker.internal..."
              sed -i 's/@tynys-postgres\([:/]\)/@host.docker.internal\1/g' .env
              sed -i 's/@tynys-postgres$/@host.docker.internal/g' .env
            fi

            echo "==> Building Docker image..."
            docker compose -f docker-compose.prod.yml build --no-cache

            echo "==> Starting containers..."
            docker compose -f docker-compose.prod.yml up -d --remove-orphans

            echo "==> Running migrations..."
            docker compose -f docker-compose.prod.yml exec -T app npm run migrate || true

            echo "==> Health check (up to 120 seconds)..."
            for i in $(seq 1 24); do
              STATUS=$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:3010/ || true)
              [ -z "$STATUS" ] && STATUS="000"
              if [ "$STATUS" = "200" ]; then
                echo "Deploy successful! HTTP $STATUS"
                exit 0
              fi
              echo "Attempt $i/24 — HTTP $STATUS, waiting 5s..."
              sleep 5
            done

            echo "Health check failed. Dumping logs:"
            docker compose -f docker-compose.prod.yml logs --tail=50
            exit 1

      - name: Clean up old Docker images
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            docker image prune -af --filter "until=168h"
            docker builder prune -f --filter "until=168h"